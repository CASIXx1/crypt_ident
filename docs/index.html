<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; Documentation by YARD 0.9.16
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" charset="utf-8" />

  <link rel="stylesheet" href="css/common.css" type="text/css" charset="utf-8" />

<script type="text/javascript" charset="utf-8">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="class_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'><h1>CryptIdent</h1>

<p>Yet another fairly basic authentication Gem. (Authorisation, and batteries, sold separately.)</p>

<p>This is initially tied to Hanami 1.2.0+; specifically, it assumes that user entities have an API compatible with <code>Hanami::Entity</code> for accessing the field/attribute values listed below in <a href="#databaserepository-setup"><em>Database/Repository Setup</em></a> (which itself assumes a Repository API compatible with that of Hanami 1.2&#39;s Repository classes). The Gem is mostly a thin layer around <a href="https://github.com/codahale/bcrypt-ruby">BCrypt</a> that, in conjunction with Hanami entities or work-alikes, supports the most common use cases for password-based authentication:</p>

<ol>
<li><a href="#registration">Registration</a>;</li>
<li><a href="#signing-in">Signing in</a>;</li>
<li><a href="#signing-out">Signing out</a>;</li>
<li><a href="#password-change">Password change</a>;</li>
<li><a href="#password-reset">Password reset</a>; and</li>
<li><a href="#session-expiration">Session expiration</a>.</li>
</ol>

<p>It <em>does not</em> implement features such as</p>

<ol>
<li>Password-strength testing;</li>
<li>Password occurrence in a <a href="https://www.passwordrandom.com/most-popular-passwords">list of most popular (and easily hacked) passwords</a>; or</li>
<li>Password ageing (requiring password changes after a period of time).</li>
</ol>

<p>These either violate current best-practice recommendations from security leaders (e.g., NIST and others no longer recommend password ageing as a defence against cracking) or have other Gems that focus on the features in question (e.g., <a href="https://github.com/bdmac/strong_password"><code>bdmac/strong_password</code></a>).</p>

<h1>Installation</h1>

<p>Add this line to your application&#39;s Gemfile:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>crypt_ident</span><span class='tstring_end'>&#39;</span></span>
</code></pre>

<p>And then execute:</p>

<pre class="code ruby"><code class="ruby">$ bundle
</code></pre>

<p>Or install it yourself as:</p>

<pre class="code ruby"><code class="ruby">$ gem install crypt_ident
</code></pre>

<h1>Usage</h1>

<h2>Database/Repository Setup</h2>

<p><code>CryptIdent</code> makes as few assumptions as possible about the Entity and persistence layer (e.g., Repository) used for your user data; put simply, we don&#39;t care what it&#39;s <em>called</em> so much as we care what it <em>is</em>.</p>

<p>We assume that the persistence layer implements the &quot;usual&quot; common methods (<code>#create</code>, <code>#update</code>, <code>#delete</code>, etc) conforming to an interface compatible with <a href="https://github.com/hanami/model/blob/master/lib/hanami/repository.rb"><code>Hanami::Repository</code></a>. This interface is suitably generic and sufficiently widely implemented, even in ORMs such as ActiveRecord that make no claim to implementing the <a href="https://8thlight.com/blog/mike-ebert/2013/03/23/the-repository-pattern.html">Repository Pattern</a>.</p>

<p>That being said, the data store underlying that persistence layer <strong>must</strong> have the following fields:</p>

<table><thead>
<tr>
<th>Field</th>
<th style="text-align: left">Type</th>
<th>Description</th>
</tr>
</thead><tbody>
<tr>
<td><code>password_hash</code></td>
<td style="text-align: left">text</td>
<td>Encrypted password string.</td>
</tr>
<tr>
<td><code>reset_sent_at</code></td>
<td style="text-align: left">timestamp without time zone</td>
<td>Defaults to <code>nil</code>; set this to the current time (<code>Time.now</code>) when responding to a password-reset request (e.g., by email). The <code>token</code> (below) will expire at this time offset by the <code>reset_expiry</code> configuration value (below)</td>
</tr>
<tr>
<td><code>token</code></td>
<td style="text-align: left">text</td>
<td>A URL-safe secure random number (see <a href="https://ruby-doc.org/stdlib-2.5.1/libdoc/securerandom/rdoc/Random/Formatter.html#method-i-urlsafe_base64">standard-library documentation</a>) used to uniquely identify a password-reset request.</td>
</tr>
</tbody></table>

<h2>Configuration</h2>

<p>The currently-configurable details for <code>CryptIdent</code> are as follows:</p>

<table><thead>
<tr>
<th style="text-align: left">Key</th>
<th style="text-align: left">Default</th>
<th style="text-align: left">Description</th>
</tr>
</thead><tbody>
<tr>
<td style="text-align: left"><code>error_key</code></td>
<td style="text-align: left"><code>:error</code></td>
<td style="text-align: left">Modify this setting if you want to use a different key for flash messages reporting unsuccessful actions.</td>
</tr>
<tr>
<td style="text-align: left"><code>guest_user</code></td>
<td style="text-align: left"><code>nil</code></td>
<td style="text-align: left">This value is used for the session variable <code>session[:current_user]</code> when no user has <a href="#signing-in">signed in</a>, or after a previously-authenticated user has <a href="#signing-out">signed out</a>. If your application makes use of the <a href="https://en.wikipedia.org/wiki/Null_object_pattern">Null Object pattern</a>, you would assign your null object instance to this configuration setting. (See <a href="https://robots.thoughtbot.com/rails-refactoring-example-introduce-null-object">this Thoughtbot post</a> for a good discussion of Null Objects in Ruby.)</td>
</tr>
<tr>
<td style="text-align: left"><code>hashing_cost</code></td>
<td style="text-align: left">8</td>
<td style="text-align: left">This is the <a href="https://github.com/codahale/bcrypt-ruby#cost-factors">hashing cost</a> used to <em>encrypt a password</em> and is applied at the hashed-password-creation step; it <strong>does not</strong> modify the default cost for the encryption engine. <strong>Note that</strong> any change to this value <em>should</em> invalidate and make useless all existing hashed-password stored values.</td>
</tr>
<tr>
<td style="text-align: left"><code>reset_expiry</code></td>
<td style="text-align: left">86400</td>
<td style="text-align: left">Number of seconds from the time a password-reset request token is stored before it becomes invalid.</td>
</tr>
<tr>
<td style="text-align: left"><code>session_expiry</code></td>
<td style="text-align: left">900</td>
<td style="text-align: left">Number of seconds <em>from either</em> the time that a user is successfully authenticated <em>or</em> the <code>restart_session_counter</code> method is called <em>before</em> a call to <code>session_expired?</code> will return <code>true</code>.</td>
</tr>
<tr>
<td style="text-align: left"><code>success_key</code></td>
<td style="text-align: left">:success</td>
<td style="text-align: left">Modify this setting if you want to use a different key for flash messages reporting successful actions.</td>
</tr>
<tr>
<td style="text-align: left"><code>token_bytes</code></td>
<td style="text-align: left">16</td>
<td style="text-align: left">Number of bytes of random data to generate when building a password-reset token. See <code>token</code> in the <a href="#databaserepository-setup">database/repository setup</a> section, above.</td>
</tr>
<tr>
<td style="text-align: left"><code>validity_time</code></td>
<td style="text-align: left">600</td>
<td style="text-align: left">Number of seconds from the time a user successfully <a href="#signing-in">signs in</a> before a call to <code>session_expired?</code> will return <code>true</code> rather than <code>false</code>.</td>
</tr>
</tbody></table>

<p>For example</p>

<pre class="code ruby"><code class="ruby">  <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>
  <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span><span class='period'>.</span><span class='id identifier rubyid_configure_crypt_id'>configure_crypt_id</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_config'>config</span><span class='op'>|</span>
    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_error_key'>error_key</span> <span class='op'>=</span> <span class='symbol'>:alert</span>
    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_hashing_cost'>hashing_cost</span> <span class='op'>=</span> <span class='int'>6</span> <span class='comment'># less secure and less resource-intensive
</span>    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_token_bytes'>token_bytes</span> <span class='op'>=</span> <span class='int'>20</span>
    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_reset_expiry'>reset_expiry</span> <span class='op'>=</span> <span class='int'>7200</span> <span class='comment'># two hours; &quot;we run a tight ship here&quot;
</span>    <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_guest_user'>guest_user</span> <span class='op'>=</span> <span class='const'>UserRepository</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_guest_user'>guest_user</span>
  <span class='kw'>end</span>
</code></pre>

<p>would change the configuration as you would expect whenever that code was run. (We <strong>recommend</strong> that this be done inside the <code>controller.prepare</code> block of your Hanami <code>web</code> (or equivalent) app&#39;s <code>application.rb</code> file.)</p>

<h2>API Documentation</h2>

<p>See <a href="./docs/index.html">the Documentation Index</a></p>

<h2>Introductory Notes on Workflows</h2>

<h3>Callables are Essential</h3>

<p>A <em>Callable</em> in Ruby is a block, a Proc, or a lambda; technically, any object instance where</p>

<ol>
<li>its <code>#initialize</code> method has an <a href="https://en.wikipedia.org/wiki/Arity">arity</a> of 0, meaning it can be called without specifying additional arguments; and</li>
<li>has a <code>#call</code> instance method whose arity is specific to the <code>CryptIdent</code> method in question.</li>
</ol>

<p>Callables other than blocks are generally specified as method parameters.</p>

<p>Unless otherwise noted, each of the methods described in the workflows below expect to be supplied a block that will be called after any preconditions have been verified, that would typically persist data to a Repository or other data store. That block would take arguments as described for each such method. If such a block is expected but not supplied, the failure will be noted in a censorious message written as an <code>ERROR</code>-level log line, with no external data being modified.</p>

<p>If any error is detected prior to calling that &quot;success&quot; block for a method, and if a Callable is specified as the <code>on_error:</code> parameter for that method, then it will be called and passed a single string containing the appropriate error message.</p>

<p>In this way, <code>CryptIdent</code> is decoupled from any persistence layer and session-data store you may be using. It is completely agnostic to how data persistence is implemented in your app. You could be using <code>Hanami::Model</code>, ROM, Sequel, or even ActiveRecord, and those details would be invisible to the <code>CryptIdent</code> code, presuming the requirements defined in <a href="#sample-user-entity-and-repository-layouts">_Sample User Entity and Repository Layouts</a> are met.</p>

<p>At the same time, of course, it <em>drastically</em> reduces the dependencies of this Gem. By delegating to you all responsibility for data access and persistence in a structured, defined manner, this Gem need not depend on <code>Hanami::Model</code> or any other persistence-layer implementation. The Entity and Repository interfaces that that class&#39; ecosystem implement are sufficiently generic and feasibly portable that <code>CryptIdent</code> may specify, for example, what attributes are required on an Entity without any knowledge of how or by whom that Entity is actually implemented.</p>

<p>This solves problems that otherwise would have either tied us down to a particular persistence implementation or tied us up for an unknowable-in-advance time figuring out how to make generics work in a language without formal interfaces. 😅</p>

<h3>Session Handling Not Automatic</h3>

<p>If you&#39;ve set up your <code>controller.prepare</code> block as <strong>recommended</strong> in the preceding section, <code>CryptIdent</code> is loaded and configured but <em>does not</em> implement session-handling &quot;out of the box&quot;; as with <a href="https://github.com/sebastjan-hribar/tachiban#session-handling">other libraries</a>, it must be implemented <em>by you</em> as described in the <a href="#session-expiration"><em>Session Expiration</em></a> description below.</p>

<h3>Sample User Entity and Repository Layouts</h3>

<p>These workflow descriptions demonstrate <em>sample</em> <code>User</code> Entity and Repository layouts; you are free to adapt them, with the aid of the <a href="#configuration"><em>Configuration</em></a> settings detailed above, to your specific needs.</p>

<p>This Gem places no expectations on the Repository, since it hands off any interaction with Repositories to blocks (for writes) or method parameters (for reads).</p>

<p>For the <code>User</code> <em>Entity</em>, we require the following attribute names:</p>

<ul>
<li><code>name</code>: The name of an individual User to be authenticated;</li>
<li><code>email</code>: The email address for that User, to be used for password recovery, for example;</li>
<li><code>hashed_pass</code>: The password associated with that User, <em>encrypted</em> using <a href="https://github.com/codahale/bcrypt-ruby">BCrypt</a> or equivalent;</li>
<li><code>password_reset_sent_at</code>: When set, this specifies the Expiration Time of the Password Reset Token in that User&#39;s <code>token</code> attribute; calls to <code>#reset_password</code> after that time will fail. Initially defaults to <code>nil</code>; set to zero (<code>0000-01-01 00:00</code> local time) after successful Password Reset.</li>
<li><code>token</code>: Defaulting to <code>nil</code>, when set, this is a unique, expireable Password Reset Token that will no longer be valid after the time stored in the <code>password_reset_sent_at</code> attribute.</li>
</ul>

<h3>Code Samples in API Reference are Authoritative</h3>

<p>Code snippets are included here to help explain use cases. However, the <a href="docs/CryptIdent.html">API Reference</a> should be considered authoritative; any discrepancies between the API and/or code snippets there and here should be regarded as a bug (and a <a href="https://github.com/jdickey/crypt_ident/issues/">report</a> filed if not already filed.</p>

<h3>Terminology and the project Ubiquitous Language</h3>

<p>Finally, a note on terminology. Terms that have meaning (e.g., <em>Guest User</em>) within this module&#39;s domain language, or <a href="https://www.martinfowler.com/bliki/UbiquitousLanguage.html">Ubiquitous Language</a>, <strong>must</strong> be capitalised, at least on first use within a paragraph. This is to stress to the reader that, while these terms may have &quot;obvious&quot; meanings, their use within this module and its related documents (including this one) <strong>should</strong> be consistent, specific, and rigorous in their meaning. In the <a href="docs/CryptIdent.html">API Documentation</a>, each of these terms <strong>must</strong> be listed in the <em>Ubiquitous Language Terms</em> section under each method description in which they are used.</p>

<p>After the first usage in a paragraph, the term <strong>may</strong> be used less strictly (e.g., by referring to a <em>Clear-Text Password</em> simply as a <em>password</em> <em>if</em> doing so does not introduce ambiguity or confusion. The reader should feel free to <a href="https://github.com/jdickey/cript_ident/issues">open an issue report</a> if you spot any lapses. (Thank you!)</p>

<h2>Use-Case Workflows</h2>

<h3>Registration</h3>

<p>Method involved:</p>

<pre class="code ruby"><code class="ruby">  <span class='kw'>module</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>
    <span class='kw'>def</span> <span class='id identifier rubyid_add_password'>add_password</span><span class='lparen'>(</span><span class='id identifier rubyid_password'>password</span><span class='comma'>,</span> <span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='label'>current_user:</span><span class='comma'>,</span> <span class='label'>on_error:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>&amp;</span><span class='id identifier rubyid_on_success'>on_success</span><span class='rparen'>)</span>
      <span class='comment'># ...
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
</code></pre>

<p>This is the first of our use cases that involves calling a function which expects a block to be supplied; if one isn&#39;t, then a log-format warning message will remind you of the error.</p>

<h4>Golden Path</h4>

<p>Given:</p>

<ol>
<li>a valid password;</li>
<li>a Hash of parameters from which any <code>password</code>-related entries have been removed;</li>
<li>A <code>:name</code> parameter within that Hash that does not already exist in the User Repository; and</li>
<li>No Authenticated Member as the Current User,</li>
</ol>

<p>the block will be called with an <code>attribs</code> Hash containing the original non-password parameter Hash with the addition of a <code>hashed_pass</code> key, whose value is the encrypted value of the specified <code>password</code>.</p>

<p>Any entries whose key matches the regular expression <code>/^.*password.*/</code> will be silently removed from the <code>attribs</code> yielded to the block.</p>

<p>Rough example code for Controller Action Class:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># apps/web/controllers/sessions/create.rb
</span>
<span class='kw'>module</span> <span class='const'>Web</span><span class='op'>::</span><span class='const'>Controllers</span><span class='op'>::</span><span class='const'>Sessions</span>
  <span class='kw'>class</span> <span class='const'>Create</span>
    <span class='id identifier rubyid_include'>include</span> <span class='const'>Web</span><span class='op'>::</span><span class='const'>Action</span> <span class='comment'># standard Hanami Action methods, etc
</span>    <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>

    <span class='id identifier rubyid_expose'>expose</span> <span class='symbol'>:user</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_repo'>repo</span> <span class='op'>=</span> <span class='const'>UserRepository</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span>
      <span class='ivar'>@repo</span> <span class='op'>=</span> <span class='id identifier rubyid_repo'>repo</span>
      <span class='ivar'>@error</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='comment'># Belt-and-suspenders mode; should already be `nil`
</span>      <span class='ivar'>@user</span> <span class='op'>=</span> <span class='kw'>nil</span> <span class='comment'># ditto
</span>    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid__params'>_params</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_add_password'>add_password</span><span class='lparen'>(</span><span class='id identifier rubyid_password'>password</span><span class='comma'>,</span> <span class='id identifier rubyid_others'>others</span><span class='comma'>,</span>
        <span class='label'>current_user:</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:current_user</span><span class='rbracket'>]</span><span class='comma'>,</span>
        <span class='label'>on_error:</span> <span class='id identifier rubyid_method'>method</span><span class='lparen'>(</span><span class='symbol'>:report_errors</span><span class='rparen'>)</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_attribs'>attribs</span><span class='op'>|</span>
        <span class='comment'># Params OK and no Authenticated Current User;
</span>        <span class='comment'>#   add to the Repository
</span>        <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>UserRepository</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='id identifier rubyid_attribs'>attribs</span><span class='rparen'>)</span>
      <span class='kw'>end</span>
      <span class='comment'># any additional redirect, cleanup, logging, etc goes here
</span>    <span class='kw'>end</span>

    <span class='id identifier rubyid_private'>private</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_others'>others</span>
      <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid__v'>_v</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>password</span><span class='regexp_end'>/</span></span> <span class='rbrace'>}</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_password'>password</span>
      <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='symbol'>:password</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_report_errors'>report_errors</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_error_params'>error_params</span><span class='rparen'>)</span>
      <span class='comment'># ...
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

</code></pre>

<p>Oh, and <strong>one more thing!</strong> Since we don&#39;t have any controller-specific code in <code>CryptIdent</code>, you could use cleaner architecture and put the logic into an Interactor: That would leave your Controller Action Class looking something like</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># apps/web/controllers/sessions/create.rb
</span>
<span class='kw'>module</span> <span class='const'>Web</span><span class='op'>::</span><span class='const'>Controllers</span><span class='op'>::</span><span class='const'>Sessions</span>
  <span class='kw'>class</span> <span class='const'>Create</span>
    <span class='id identifier rubyid_include'>include</span> <span class='const'>Web</span><span class='op'>::</span><span class='const'>Action</span> <span class='comment'># standard Hanami Action methods, etc
</span>    <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>

    <span class='id identifier rubyid_expose'>expose</span> <span class='symbol'>:user</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid__params'>_params</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_result'>result</span> <span class='op'>=</span> <span class='const'>CreateNewUserFrom</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='label'>current_user:</span> <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:current_user</span><span class='rbracket'>]</span><span class='rparen'>)</span>
      <span class='ivar'>@user</span> <span class='op'>=</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_user'>user</span>
      <span class='id identifier rubyid_transfer_errors'>transfer_errors</span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_errors'>errors</span><span class='rparen'>)</span> <span class='kw'>unless</span> <span class='id identifier rubyid_result'>result</span><span class='period'>.</span><span class='id identifier rubyid_success?'>success?</span>
      <span class='id identifier rubyid_set_flash_from'>set_flash_from</span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span>
      <span class='comment'># Redirect, etc
</span>    <span class='kw'>end</span>

    <span class='id identifier rubyid_private'>private</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_set_flash_from'>set_flash_from</span><span class='lparen'>(</span><span class='id identifier rubyid_result'>result</span><span class='rparen'>)</span>
      <span class='comment'># ...
</span>    <span class='kw'>end</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_transfer_errors'>transfer_errors</span><span class='lparen'>(</span><span class='id identifier rubyid_result_errors'>result_errors</span><span class='rparen'>)</span>
      <span class='comment'># ...
</span>    <span class='kw'>end</span>
  <span class='kw'>end</span> <span class='comment'># class Create
</span><span class='kw'>end</span>
</code></pre>

<p>and the Interactor becomes something like</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># lib/your_app/interactors/create_new_user_from.rb
</span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>hanami/interactor</span><span class='tstring_end'>&#39;</span></span>

<span class='kw'>class</span> <span class='const'>CreateNewUserFrom</span>
  <span class='id identifier rubyid_include'>include</span> <span class='const'>Hanami</span><span class='op'>::</span><span class='const'>Interactor</span>

  <span class='id identifier rubyid_expose'>expose</span> <span class='symbol'>:user</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='label'>repo:</span> <span class='const'>UserRepository</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='rparen'>)</span>
    <span class='ivar'>@repo</span> <span class='op'>=</span> <span class='id identifier rubyid_repo'>repo</span>
  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='comma'>,</span> <span class='label'>current_user:</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_call_params'>call_params</span> <span class='op'>=</span> <span class='lbrace'>{</span>
      <span class='label'>current_user:</span> <span class='id identifier rubyid_current_user'>current_user</span><span class='comma'>,</span> <span class='label'>on_error:</span> <span class='id identifier rubyid_method'>method</span><span class='lparen'>(</span><span class='symbol'>:report_errors</span><span class='rparen'>)</span>
    <span class='rbrace'>}</span>
    <span class='id identifier rubyid_password'>password</span><span class='comma'>,</span> <span class='id identifier rubyid_others'>others</span> <span class='op'>=</span> <span class='id identifier rubyid_split_params'>split_params</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_add_password'>add_password</span><span class='lparen'>(</span><span class='id identifier rubyid_password'>password</span><span class='comma'>,</span> <span class='id identifier rubyid_others'>others</span><span class='comma'>,</span> <span class='id identifier rubyid_call_params'>call_params</span><span class='rparen'>)</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_attribs'>attribs</span><span class='op'>|</span>
      <span class='comment'># Params OK and no Authenticated Current User;
</span>      <span class='comment'>#   add to the Repository
</span>      <span class='ivar'>@user</span> <span class='op'>=</span> <span class='const'>UserRepository</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='period'>.</span><span class='id identifier rubyid_create'>create</span><span class='lparen'>(</span><span class='id identifier rubyid_attribs'>attribs</span><span class='rparen'>)</span>
      <span class='kw'>true</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_report_errors'>report_errors</span><span class='lparen'>(</span><span class='op'>**</span><span class='id identifier rubyid_error_params'>error_params</span><span class='rparen'>)</span>
    <span class='comment'># ...
</span>  <span class='kw'>end</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_split_password'>split_password</span><span class='lparen'>(</span><span class='id identifier rubyid_params'>params</span><span class='rparen'>)</span>
    <span class='id identifier rubyid_password'>password</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_dig'>dig</span><span class='lparen'>(</span><span class='symbol'>:password</span><span class='rparen'>)</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span>
    <span class='id identifier rubyid_others'>others</span> <span class='op'>=</span> <span class='id identifier rubyid_params'>params</span><span class='period'>.</span><span class='id identifier rubyid_to_h'>to_h</span><span class='period'>.</span><span class='id identifier rubyid_reject'>reject</span> <span class='lbrace'>{</span> <span class='op'>|</span><span class='id identifier rubyid_k'>k</span><span class='comma'>,</span> <span class='id identifier rubyid__v'>_v</span><span class='op'>|</span> <span class='id identifier rubyid_k'>k</span><span class='period'>.</span><span class='id identifier rubyid_to_s'>to_s</span> <span class='op'>=~</span> <span class='tstring'><span class='regexp_beg'>/</span><span class='tstring_content'>password</span><span class='regexp_end'>/</span></span> <span class='rbrace'>}</span>
    <span class='lbracket'>[</span><span class='id identifier rubyid_password'>password</span><span class='comma'>,</span> <span class='id identifier rubyid_others'>others</span><span class='rbracket'>]</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p><em>Having said that, and bearing in mind that we **recommend</em>* using Interactors rather than controllers for domain logic*, we&#39;ll continue to demonstrate controller code for presentational brevity.</p>

<h4>Error Condition — Run While a Member is Authenticated</h4>

<p>We verify that no Authenticated User is passed in as the <code>current_user</code> parameter. If one is, then <em>whether or not</em> an <code>on_error</code> handler is specified as discussed below, the code in the block parameter passed in to <code>#add_password</code> <em>is not</em> executed. Any variables, such as <code>@user</code> in the <em>Golden Path</em> example code above, will not be changed from their previous value (or <code>nil</code> if no value had previously been assigned.)</p>

<h5>With An <code>on_error</code> Handler</h5>

<p>We <strong>recommend</strong> that an <code>on_error</code> handler be specified for each call to <code>#add_password</code>. This will allow you to perform error reporting, either by adding values to <code>params.errors</code> for Controller Actions or by calling <code>error!</code> for Interactors, in a method visually and logically separate from the calling method.</p>

<p>For example, in a Controller Action Class,</p>

<pre class="code ruby"><code class="ruby">
# apps/web/controllers/sessions/create.rb

module Web::Controllers::Sessions
  class Create
    include Web::Action # standard Hanami Action methods, etc
    include CryptIdent

    expose :user

    def initialize(repo = UserRepository.new)
      # ... as before ...
    end

    def call(_params)
      ret = add_password(password, others,
        current_user: session[:current_user],
        on_error: method(:report_errors)) do |attribs|
        # Oops! The block is never yielded to
        @user = UserRepository.new.create(attribs)
      end
      return false if possible_errors.include? ret
      # additional redirect, cleanup, logging, etc for success never executes
      ret
    end

    private

    def report_errors(**error_params)
      if error_params.dig(:current_user_exists)
        flash[:error] = error_params[:current_user_exists]
      elsif error_params.dig(:current_user_exists
    end
  end
end

</code></pre>

<h5>With No <code>on_error</code> Handler Specified</h5>

<h4>Error Condition —</h4>

<hr>

<hr>

<hr>

<p>If the passed-in <code>current_user</code> value is an Authenticated User, the method will call the Callable passed in as <code>:on_error</code>, passing it two arguments: the error symbol <code>:current_user_exists</code> and the value of the <code>current_user</code> argument. It will then return <code>:current_user_exists</code> as the method&#39;s 
return <code>:current_user_exists</code> after calling the <code>FOODOOFOO</code></p>

<p>To build an Entity suitable for saving to the appropriate Repository, call the <code>add_password</code> method, passing in a Hash of attributes and a plain-text password as parameters. The method yields to its block on success a Hash containing the entries supplied in the parameter, with the addition of a <code>password_hash</code> entry whose value is the encrypted value of the supplied plain-text password.</p>

<p>If the supplied plain-text password is an empty string, blank, or <code>nil</code>, then the <code>password_hash</code> attribute of the returned entity will be randomised, requiring a <a href="#password-reset"><em>Password Reset</em></a> before the user can <a href="#signing-in"><em>Sign In</em></a>.</p>

<p>Once the new attribute Hash with an encrypted <code>password_hash</code> has been returned from <code>add_password</code>, it may be used to build and persist an Entity as you normally would.</p>

<h3>Signing In</h3>

<p>Once a user has been <a href="#registration">Registered</a>, signing in is a matter of retrieving that user&#39;s Entity (containing a <code>password_hash</code> attribute) and calling <code>#sign_in</code> passing in that Entity and the supplied clear-text password, and seeing what the return value is.</p>

<p>If the supplied clear-text password is <em>incorrect</em>, then <code>#sign_in</code> will return <code>nil</code>.</p>

<p>If it is <em>correct</em>, then the return value will be <code>true</code>.</p>

<p><strong>Note that</strong> <code>#sign_in</code> interacts with session data if available. (In unit tests, it often is not.) Specifically:</p>

<p>On <em>success</em>:</p>

<ul>
<li><code>session[:start_time]</code> is set to the current time as returned by <code>Time.now</code> when called from within the method;</li>
<li><code>session[:current_user]</code> is set to the <em>Entity</em> (not the ID value from the Repository) for the now-logged-in user.  This is to eliminate repeated reads of the Repository.</li>
</ul>

<p>On <em>failure</em>:</p>

<ul>
<li><code>session[:start_time]</code> is set to <code>0000-01-01 00:00:00 +0000</code>;</li>
<li><code>session[:current_user]</code> is set to <a href="#configuration"><code>config.guest_user</code></a>.</li>
</ul>

<p>If a <em>different user</em> is logged in (as evidenced by <code>session[:current_user]</code>), then <code>#sign_in</code> returns <code>false</code> and the <code>session</code> data remains unchanged.</p>

<h3>Signing Out</h3>

<p>Signing out a previously Authenticated user is straightforward: call the <code>sign_out</code> method.</p>

<p>If the <code>session[:current_user]</code> value <em>does not</em> have the value of <a href="#configuration"><code>config.guest_user</code></a>, <code>session[:start_time]</code> is set to <code>0000-01-01 00:00:00 +0000</code>, and the method returns <code>true</code>.</p>

<p>If <code>session[:current_user]</code> <em>is</em> the Guest User, then <code>session[:start_time]</code> is cleared as above, and the method returns <code>false</code>.</p>

<p>In neither case is any data but the <code>session</code> values affected.</p>

<h3>Password Change</h3>

<p>To change an <a href="#signing-in">authenticated</a> user&#39;s password, the current clear-text password, new clear-text password, and clear-text password confirmation are passed to <code>change_password</code>.</p>

<p>If the Encrypted Password in the <code>session[:current_user]</code> entity does not match the encrypted value of the specified current Clear-Text Password, then the method returns <code>:bad_password</code> and no changes occur.</p>

<p>If the current-password check succeeds but the new Clear-Text Password and its confirmation do not match, then the method returns <code>:mismatched_password</code> and no changes occur.</p>

<p>If the new Clear-Text Password and its confirmation match, then the <em>encrypted value</em> of that new password is returned, and the <code>session[:current_user]</code> Entity is replaced with an Entity identical except that it has the new encrypted value for <code>hashed_password</code>.</p>

<h3>Password Reset</h3>

<p>To reset a User&#39;s password when the User <em>is not</em> <a href="#signing-in">authenticated</a> is a two-step process:</p>

<ol>
<li>Request that a password-reset link be sent to the email address associated with an individual user; and</li>
<li>Visit the unique link in the email sent in response to the first step to actually change the password.</li>
</ol>

<h4>Request a reset-password-link email message</h4>

<p>Password Reset Tokens are useful for verifying that the person requesting a Password Reset for an existing User is sufficiently likely to be the person who Registered that User or, if not, that no compromise or other harm is done.</p>

<p>Typically, this is done by sending a link through email or other such medium to the address previously associated with the User purportedly requesting the Password Reset. <code>CryptIdent</code> <em>does not</em> automate generation or sending of the email message. What it <em>does</em> provide is a method to generate a new Password Reset Token to be embedded into an HTML anchor link within an email
that you construct.</p>

<p>It also implements an expiry system, such that if the confirmation of the Password Reset request is not completed within a <a href="#Configuration">configurable</a> time, that the token is no longer valid (and cannot be later reused by unauthorised persons). </p>

<h4>Actually reset the password</h4>

<p>The <code>reset_password</code> method is called with the reset token encoded into the URL from the email in the preceding step, along with the clear-text new password and new-password confirmation parameters supplied to the action.</p>

<p>If the token is invalid or has expired, <code>reset_password</code> returns <code>:invalid_token</code> and no changes occur.</p>

<p>If the new password and confirmation do not match, <code>reset_password</code> returns <code>:mismatched_password</code> and no changes occur.</p>

<p>If the clear-text new password and its confirmation match, then the hashed value of that new password is returned, and the <code>session[:current_user]</code> Entity is replaced with an Entity identical except that it has the new value for <code>hashed_password</code>.</p>

<h3>Session Expiration</h3>

<p>Session management is a necessary part of implementing authentication (and authorisation) within an app. However,  it&#39;s not something that an authentication <em>library</em> can fully implement without making the client application excessively inflexible and brittle.</p>

<p><code>CryptIdent</code> has two convenience methods which <em>help in</em> implementing session-expiration logic; these make use of the <code>session_expiry</code> <a href="#configuration">configuration value</a>.</p>

<ul>
<li><code>CryptIdent#restart_session_counter</code> resets the session-expiry time to the current time <em>plus</em> the number of seconds specified by the <code>session_expiry</code> configuration value.</li>
<li><code>CryptIdent#session_expired?</code> returns <code>true</code> if the current time is not less than the session-expiry time; it returns <code>false</code> otherwise.</li>
</ul>

<p>Example code which uses these methods is illustrated below, as a shared-code module that may be included in your controllers&#39; action classes:</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># apps/web/controllers/handle_session.rb
</span>
<span class='kw'>module</span> <span class='const'>Web</span>
  <span class='kw'>module</span> <span class='const'>HandleSession</span>
    <span class='id identifier rubyid_include'>include</span> <span class='const'><span class='object_link'><a href="CryptIdent.html" title="CryptIdent (module)">CryptIdent</a></span></span>

    <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_included'>included</span><span class='lparen'>(</span><span class='id identifier rubyid_other'>other</span><span class='rparen'>)</span>
      <span class='id identifier rubyid_other'>other</span><span class='period'>.</span><span class='id identifier rubyid_class_eval'>class_eval</span> <span class='kw'>do</span>
        <span class='id identifier rubyid_before'>before</span> <span class='symbol'>:validate_session</span>
      <span class='kw'>end</span>
    <span class='kw'>end</span>

    <span class='id identifier rubyid_private'>private</span>

    <span class='kw'>def</span> <span class='id identifier rubyid_validate_session'>validate_session</span>
      <span class='kw'>return</span> <span class='id identifier rubyid_restart_session_counter'>restart_session_counter</span> <span class='kw'>unless</span> <span class='id identifier rubyid_session_expired?'>session_expired?</span>

      <span class='ivar'>@redirect_url</span> <span class='op'>||=</span> <span class='id identifier rubyid_routes'>routes</span><span class='period'>.</span><span class='id identifier rubyid_root_path'>root_path</span>
      <span class='id identifier rubyid_session'>session</span><span class='lbracket'>[</span><span class='symbol'>:current_user</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_guest_user'>guest_user</span>
      <span class='id identifier rubyid_error_message'>error_message</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>Your session has expired. You have been signed out.</span><span class='tstring_end'>&#39;</span></span>
      <span class='id identifier rubyid_flash'>flash</span><span class='lbracket'>[</span><span class='id identifier rubyid_config'>config</span><span class='period'>.</span><span class='id identifier rubyid_error_key'>error_key</span><span class='rbracket'>]</span> <span class='op'>=</span> <span class='id identifier rubyid_error_message'>error_message</span>
      <span class='id identifier rubyid_redirect_to'>redirect_to</span> <span class='ivar'>@redirect_url</span>
    <span class='kw'>end</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>This code should be fairly self-explanatory. Including the module adds the private <code>#validate_session</code> method to the client controller action class, adding a call to that method before the action class&#39; <code>#call</code> method is entered. If the session-expiry time has been previously set and is not before the current time, then that session-expiry time is reset based on the current time, and no further action is taken. Otherwise:</p>

<ol>
<li>The <code>current_user</code> setting in the session data is overwritten with the <a href="#configuration"><code>config.guest_user</code></a> value (defaulting to <code>nil</code>);</li>
<li>A flash error message is set, which <strong>should</strong> be rendered within the controller action&#39;s view; and</li>
<li>Control is redirected to the path or URL specified by <code>@redirect_url</code>, defaulting to the root path (<code>/</code>).</li>
</ol>

<p>This code will be instantly familiar to anyone coming from another framework like Rails, where the conventional way to ensure authentication before a controller action is executed is to add a <code>:before</code> hook. Adding this module to the controller action class is also justifiable Hanami, since it depends on and interacts with session data. (Just don&#39;t let any actual domain logic <a href="http://hanamirb.org/guides/1.2/actions/control-flow/#proc">taint</a> your controller callbacks; that&#39;s begging for difficult-to-debug problems going forward.</p>

<h1>Development</h1>

<p>After checking out the repo, run <code>bin/setup</code> to install dependencies. If you use <a href="https://github.com/rbenv/rbenv"><code>rbenv</code></a> and <a href="https://github.com/jf/rbenv-gemset"><code>rbenv-gemset</code></a>, the <code>setup</code> script will create a new Gemset (in <code>./tmp/gemset</code>) to keep your system Gem repository pristine. Then, run <code>bin/rake test</code> to run the tests, or <code>bin/rake</code> without arguments to run tests and all static-analysis tools (<a href="https://github.com/seattlerb/flog">Flog</a>, <a href="https://github.com/seattlerb/flay">Flay</a>, <a href="https://github.com/troessner/reek">Reek</a>, and <a href="https://github.com/rubocop-hq/rubocop/">RuboCop</a>). Running <code>bin/rake inch</code> will let <a href="http://trivelop.de/inch/">Inch</a> comment on the amount of internal documentation in the project.</p>

<p>You can also run <code>bin/console</code> for an interactive prompt that will allow you to experiment.</p>

<p>To install this gem onto your local machine, run <code>bin/rake install</code> or <code>bundle exec rake install</code>. To release a new version, update the version number in <code>version.rb</code>, and then run <code>bin/rake release</code> or <code>bundle exec rake release</code>, which will create a Git tag for the version, push Git commits and tags, and push the <code>.gem</code> file to <a href="https://rubygems.org">rubygems.org</a>.</p>

<h1>Contributing</h1>

<p>Bug reports and pull requests are welcome on GitHub at <a href="https://github.com/jdickey/crypt_ident">https://github.com/jdickey/crypt_ident</a>. This project is intended to be a safe, welcoming space for collaboration, and contributors are expected to adhere to the <a href="http://contributor-covenant.org">Contributor Covenant</a> code of conduct.</p>

<h1>License</h1>

<p>The gem is available as open source under the terms of the <a href="https://opensource.org/licenses/MIT">MIT License</a>.</p>

<h1>Code of Conduct</h1>

<p>Everyone interacting in the CryptIdent project’s codebases, issue trackers, chat rooms and mailing lists is expected to follow the <a href="https://github.com/jdickey/crypt_ident/blob/master/CODE_OF_CONDUCT.md">code of conduct</a>.</p>
</div></div>

      <div id="footer">
  Generated on Tue Oct 30 03:24:26 2018 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.16 (ruby-2.5.3).
</div>

    </div>
  </body>
</html>